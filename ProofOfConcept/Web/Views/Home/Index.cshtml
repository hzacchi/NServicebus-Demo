@{
    ViewBag.Title = "Index";
}

<style>
    .section {height:250px} 
    .clear {clear:both}
    
    #packout { float: left;width: 47.5%}
    #scrap { float: right;width: 47.5%}

    ul {list-style-type: none}
    ul li { float: left;width: 30%;height: 25px;background-color: gray;margin: 0px 2px 2px 0px;color: white;text-align: center;padding: 2px 0px 0px 2px}
    ul li.pending {background-color: orange}
    ul li.passed {background-color: green}
    ul li.failed {background-color: red}
</style>

<fieldset id="wip" class="section">
    <legend>Wip Release</legend>
    <section>
        Next Wip Released In: <span id="timer"></span> seconds
    </section>
    <ul></ul>
    <div class="clear"></div>
</fieldset>


<fieldset id="assemble" class="section">
    <legend>Assemble</legend>
    <ul></ul>
    <div class="clear"></div> 
</fieldset>


<fieldset id="packout" class="section">
    <legend>Packout</legend>
    <ul></ul>
    <div class="clear"></div>
</fieldset>


<fieldset id="scrap" class="section">
    <legend>Scrap</legend>
    <ul></ul>
    <div class="clear"></div>
</fieldset>
 
<div class="clear"></div>

<script src="~/scripts/jquery-1.6.4.js" type="text/javascript"></script>
<script src="~/scripts/jquery.signalR-2.0.0-beta2.js" type="text/javascript"></script>
<script src="~/signalr/hubs"></script>
<script type="text/javascript">

    var router = $.connection.routingHub;


    router.client.wipReleased = function (data) {
        console.log('wipReleased', data);
        var li = $("ul li#" + data.WipId);
        li.removeClass("pending");
    };

    router.client.assemblePassed = function (data) {
        console.log('assemblePassed', data);
        var li = $("ul li#" + id);
        li.addClass('passed');
    };

    router.client.assembleFailed = function (data) {
        console.log('assembleFailed', data);
        var li = $("ul li#" + id);
        li.addClass('failed');
    };

    router.client.wipMovedToAssemble = function (data) {
        console.log('wipMovedToAssemble', data);
        moveTo("#assemble", data.WipId);

        setTimeout('passOrFail("' + data.WipId + '")', 2000);
    };

    router.client.wipMovedToPackout = function (data) {
        console.log('wipMovedToPackout', data);
        moveTo("#packout", data.WipId);
    };

    router.client.wipMovedToScrap = function (data) {
        console.log('wipMovedToScrap', data);
        moveTo("#scrap", data.WipId);
    };

    $.connection.hub.start()
        .done(function() { console.log('Now connected, connection ID=' + $.connection.hub.id); })
        .fail(function () {
            console.log('Could not Connect!');
        });
  

    $(function () { 
        releaseWipTimer(); 
    });
     
    var wipReleaseTimer = 1;
    function releaseWipTimer() {
        $('#timer').html(wipReleaseTimer);
        
        if (wipReleaseTimer == 0) {
            releaseWip();
            wipReleaseTimer = 5;
        } else {
            wipReleaseTimer--;
        }
        
        setTimeout('releaseWipTimer()', 1000);
    }

    function releaseWip() {
        $.post('/api/wip', {}, function(id) {
            var li = $('<li class="pending">' + id + "</li>");
            li.attr("id", id);
            $('#wip ul').append(li);
        });
    }

    function moveTo(container, id) {
        var li = $("ul li#" + id);
        li.remove();
        $('ul', container).append(li);
    }

    function passOrFail(id) {  
        $.post('/api/assemble/' + id, {}, function () {
            
        });
    }
</script>